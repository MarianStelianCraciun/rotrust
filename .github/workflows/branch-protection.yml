name: Branch Protection

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  enforce-branch-protection:
    runs-on: ubuntu-latest
    steps:
      - name: Check if push is direct to main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Allow the repository owner to push directly to main
          if [ "${{ github.actor }}" == "MarianStelianCraciun" ]; then
            echo "Repository owner detected. Allowing direct push to main branch."
          else
            echo "Direct pushes to main branch are not allowed!"
            echo "Please create a pull request instead."
            exit 1
          fi
          
      - name: Checkout code
        uses: actions/checkout@v3
        if: github.event_name == 'pull_request'
        
      - name: Check for required approval
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          REQUIRED_APPROVER: "MarianStelianCraciun"  # Replace with the actual username
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "Pull request to main branch detected."
          
          # Skip approval check if the PR author is the required approver
          if [ "$PR_AUTHOR" == "$REQUIRED_APPROVER" ]; then
            echo "✅ Pull request author is $REQUIRED_APPROVER. Approval check skipped."
            echo "This PR can be merged to the main branch."
            exit 0
          fi
          
          echo "Checking for required approval from $REQUIRED_APPROVER..."
          
          # Get the list of reviews for this PR
          REVIEWS=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews")
          
          # Check if the required approver has approved the PR
          APPROVED=$(echo $REVIEWS | jq -r --arg APPROVER "$REQUIRED_APPROVER" '.[] | select(.user.login==$APPROVER and .state=="APPROVED") | .state')
          
          if [ "$APPROVED" == "APPROVED" ]; then
            echo "✅ Pull request has been approved by $REQUIRED_APPROVER."
            echo "This PR can be merged to the main branch."
          else
            echo "❌ Pull request has NOT been approved by $REQUIRED_APPROVER."
            echo "This PR cannot be merged until it receives approval from $REQUIRED_APPROVER."
            exit 1
          fi
