option_settings:
  aws:elasticbeanstalk:application:environment:
    ENVIRONMENT: production
    PYTHONPATH: "/var/app:$PYTHONPATH"
    
  aws:elasticbeanstalk:container:python:
    WSGIPath: backend.main:app
    
  aws:elasticbeanstalk:environment:proxy:staticfiles:
    /static: frontend/build/static
    
  aws:autoscaling:launchconfiguration:
    InstanceType: t3.small
    SecurityGroups: rotrust-sg
    
  aws:autoscaling:asg:
    MinSize: 1
    MaxSize: 4
    
  aws:elasticbeanstalk:environment:
    LoadBalancerType: application
    ServiceRole: aws-elasticbeanstalk-service-role
    
  aws:elbv2:listener:443:
    ListenerEnabled: true
    Protocol: HTTPS
    SSLCertificateArns: arn:aws:acm:region:account-id:certificate/certificate-id
    
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
    
Resources:
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: S3
          buckets: rotrust-deployment
          roleName: aws-elasticbeanstalk-ec2-role
          
files:
  "/etc/nginx/conf.d/proxy.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      client_max_body_size 50M;
      
  "/opt/elasticbeanstalk/hooks/appdeploy/post/01_migrate.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # Source the virtual environment
      source /var/app/venv/*/bin/activate
      
      # Navigate to the application directory
      cd /var/app/current
      
      # Run database migrations
      python -m alembic upgrade head
      
      # Log the migration
      echo "Database migrations completed at $(date)" >> /var/log/migration.log
      
commands:
  01_install_dependencies:
    command: |
      yum install -y postgresql-devel